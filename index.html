<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Volt: Audio Transformer // ELPORT</title>
    <style>
        :root { --blue: #00f2ff; --panel: rgba(5, 8, 12, 0.98); }
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            margin: 0; padding: 0; 
            font-family: 'Inter', -apple-system, system-ui, sans-serif; 
        }
        body { 
            background: #000; color: #fff; padding: 20px 10px 40px 10px;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
            overflow-x: hidden; overflow-y: auto;
        }
        #star-canvas { position: fixed; inset: 0; z-index: -1; background: #000; pointer-events: none; }
        
        #ufo {
            position: fixed; top: 0; left: 0; width: 60px; height: 30px;
            pointer-events: none; z-index: 1; filter: drop-shadow(0 0 15px var(--blue));
            opacity: 0.8;
        }

        .hull-frame {
            position: relative; width: 100%; max-width: 540px; z-index: 10;
            border: 1.5px solid rgba(255, 255, 255, 0.8); border-radius: 30px;
            background: var(--panel); padding: 4px;
            box-shadow: 0 0 100px rgba(0, 0, 0, 1), 0 0 40px rgba(0, 242, 255, 0.1);
            margin-bottom: 20px;
        }
        .cockpit-inner {
            background: linear-gradient(180deg, rgba(255,255,255,0.06) 0%, rgba(0,0,0,0) 100%);
            border-radius: 26px; padding: 28px; display: flex; flex-direction: column; gap: 18px;
        }

        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 15px; }
        h1 { margin: 0; font-size: 28px; letter-spacing: 4px; color: #ffffff; text-transform: uppercase; font-weight: 900; text-shadow: 0 0 30px rgba(255, 255, 255, 0.6); }
        .branding { font-size: 10px; color: #ffffff; letter-spacing: 2.5px; text-transform: uppercase; opacity: 1; font-weight: 900; }
        #status { font-size: 8.5px; color: #fff; font-family: monospace; border: 1.5px solid #fff; padding: 4px 10px; border-radius: 4px; font-weight: 900; background: rgba(0,0,0,0.8); letter-spacing: 1px; }

        .upload-area { 
            border: 1.5px dashed rgba(255, 255, 255, 0.7); border-radius: 14px; padding: 24px; 
            text-align: center; cursor: pointer; background: rgba(255,255,255,0.04);
            transition: 0.2s; position: relative;
        }
        .upload-area:active { background: rgba(255,255,255,0.1); border-color: var(--blue); }
        #fileInput { position: absolute; inset: 0; opacity: 0; cursor: pointer; z-index: 10; width: 100%; height: 100%; }
        
        .file-label { 
            font-size: 11px; color: var(--blue); font-family: 'Inter', sans-serif; 
            text-transform: uppercase; letter-spacing: 2px; font-weight: 900;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            display: block; width: 100%; pointer-events: none;
        }

        .control-grid { opacity: 0.1; pointer-events: none; transition: 1s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column; gap: 14px; }
        .module { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); padding: 18px; border-radius: 20px; box-shadow: inset 0 0 20px rgba(0,0,0,0.4); }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        
        .label-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 10px; }
        label { font-size: 10.5px; font-weight: 900; color: #ffffff; text-transform: uppercase; letter-spacing: 1.8px; }
        .pct { font-size: 10px; color: var(--blue); font-family: monospace; font-weight: 900; text-shadow: 0 0 8px var(--blue); }

        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; height: 24px; cursor: crosshair; }
        input[type=range]::-webkit-slider-runnable-track { height: 2px; background: rgba(255,255,255,0.3); border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 2px; background: #fff; margin-top: -11px; box-shadow: 0 0 20px rgba(0, 242, 255, 0.6); transition: 0.2s; }

        .engine-val { font-size: 10px; color: var(--blue); font-weight: 900; text-transform: uppercase; letter-spacing: 1.5px; }

        .modes { display: flex; background: rgba(0,0,0,0.5); padding: 4px; border-radius: 10px; gap: 4px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.1); }
        .m-btn { flex: 1; border: none; background: transparent; color: #888; font-size: 9px; font-weight: 900; padding: 10px; border-radius: 6px; cursor: pointer; transition: 0.2s; text-transform: uppercase; letter-spacing: 1px; }
        .m-btn.active { background: #fff; color: #000; box-shadow: 0 0 15px rgba(255,255,255,0.3); }

        .hud-radar { 
            position: relative; width: 100%; height: 110px; 
            background: #000; border-radius: 16px; overflow: hidden; 
            border: 1.5px solid rgba(255,255,255,0.3); margin-top: 5px;
        }
        .hud-text { position: absolute; font-size: 8px; color: #fff; z-index: 5; padding: 12px; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 900; }
        canvas#viz { width: 100%; height: 100%; position: relative; z-index: 2; }
        
        .main-actions { display: flex; gap: 12px; margin-top: 5px; }
        #playBtn { flex: 2.5; height: 68px; border-radius: 14px; border: none; background: #fff; color: #000; font-weight: 900; font-size: 18px; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; transition: 0.2s; }
        #playBtn:active { transform: scale(0.96); }
        #exportBtn { flex: 1.2; border-radius: 14px; border: 2.5px solid rgba(255,255,255,0.6); background: transparent; color: #fff; font-size: 10px; font-weight: 900; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }
        #resetBtn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.3); color: #fff; font-size: 8px; font-weight: 900; border-radius: 14px; padding: 0 12px; cursor: pointer; text-transform: uppercase; }
        #glitch { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.4); color: #fff; padding: 15px; border-radius: 14px; cursor: pointer; font-size: 20px; transition: 0.2s; }
    </style>
</head>
<body>
    <canvas id="star-canvas"></canvas>
    
    <div id="ufo">
        <svg viewBox="0 0 100 50" xmlns="http://www.w3.org/2000/svg">
            <ellipse cx="50" cy="25" rx="40" ry="10" fill="#222" stroke="#fff" stroke-width="1.5"/>
            <path d="M30 22 Q50 5 70 22" fill="none" stroke="#fff" stroke-width="1.5"/>
            <circle cx="50" cy="25" r="3" fill="var(--blue)">
                <animate attributeName="opacity" values="0;1;0" dur="0.8s" repeatCount="indefinite" />
            </circle>
        </svg>
    </div>

    <div class="hull-frame">
        <div class="cockpit-inner">
            <header>
                <div>
                    <h1>Volt</h1>
                    <div class="branding">Audio Transformer // By : ELPORT</div>
                </div>
                <div id="status">SYSTEM ONLINE</div>
            </header>

            <div class="upload-area" id="uploadBox">
                <input type="file" id="fileInput" accept="audio/*, .mp3, .wav, .m4a">
                <div id="fileLabel" class="file-label">Tap To Transform Audio</div>
            </div>
            
            <div id="controls" class="control-grid">
                <div class="row">
                    <div class="module">
                        <div class="label-row"><label>Saturate</label><span id="drivePct" class="pct">0%</span></div>
                        <input type="range" id="drive" min="1" max="50" value="1">
                    </div>
                    <div class="module">
                        <div class="label-row"><label>Engine</label><span id="engineLabel" class="engine-val">Vocal</span></div>
                        <input type="range" id="engineType" min="0" max="4" step="1" value="4">
                    </div>
                </div>

                <div class="module" style="border: 1px solid rgba(0, 242, 255, 0.3);">
                    <div class="label-row"><label>Spectral Cybernetics</label><span id="robotPct" class="pct">0%</span></div>
                    <div class="row">
                        <div>
                            <label style="font-size: 7.5px; color: #fff;">Robot Freq</label>
                            <input type="range" id="robotFreq" min="20" max="2000" value="440">
                        </div>
                        <div>
                            <label style="font-size: 7.5px; color: #fff;">Mix</label>
                            <input type="range" id="robotMix" min="0" max="1" step="0.01" value="0">
                        </div>
                    </div>
                </div>

                <div class="module">
                    <div class="label-row"><label>Multiband Parallel Dynamics</label></div>
                    <div class="row-3">
                        <div>
                            <label style="font-size: 7.5px; color: #fff;">Lo Mix</label>
                            <input type="range" id="compLow" min="0" max="1" step="0.01" value="0">
                        </div>
                        <div>
                            <label style="font-size: 7.5px; color: #fff;">Mid Mix</label>
                            <input type="range" id="compMid" min="0" max="1" step="0.01" value="0">
                        </div>
                        <div>
                            <label style="font-size: 7.5px; color: #fff;">Hi Mix</label>
                            <input type="range" id="compHigh" min="0" max="1" step="0.01" value="0">
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="module">
                        <div class="label-row"><label>Analog Tone</label><span id="tonePct" class="pct">50%</span></div>
                        <input type="range" id="tone" min="-12" max="12" value="0">
                    </div>
                    <div class="module">
                        <div class="label-row"><label>Ghost Reverb</label><span id="reverbMixPct" class="pct">0%</span></div>
                        <input type="range" id="reverbMix" min="0" max="1" step="0.01" value="0">
                    </div>
                </div>
                
                <div class="module">
                    <div class="label-row"><label>Delay Dimension</label><span id="delayMixPct" class="pct">0%</span></div>
                    <div class="modes">
                        <button class="m-btn active" data-mode="wide">Wide</button>
                        <button class="m-btn" data-mode="pingpong">Pong</button>
                        <button class="m-btn" data-mode="slap">Slap</button>
                    </div>
                    <input type="range" id="delayMix" min="0" max="0.8" step="0.01" value="0">
                </div>

                <div class="hud-radar">
                    <span class="hud-text" style="top:0; left:0; color:#fff">Precision spectral_Scanner</span>
                    <div style="position: absolute; bottom: 5px; right: 10px; text-align: right; z-index: 10;">
                        <span id="hud-db" class="hud-text" style="position: static; display: block; color: #fff; padding: 0;">dB: -Inf</span>
                        <span id="hud-lufs" class="hud-text" style="position: static; display: block; margin-top: 2px; color: #fff; padding: 0;">LUFS: -Inf</span>
                    </div>
                    <canvas id="viz"></canvas>
                </div>

                <div class="main-actions">
                    <button id="glitch">ðŸŽ²</button>
                    <button id="resetBtn">Clear</button>
                    <button id="playBtn">Play</button>
                    <button id="exportBtn">Save HQ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            const dom = {
                file: document.getElementById('fileInput'), label: document.getElementById('fileLabel'),
                status: document.getElementById('status'), ctrls: document.getElementById('controls'),
                play: document.getElementById('playBtn'), export: document.getElementById('exportBtn'),
                reset: document.getElementById('resetBtn'),
                glitch: document.getElementById('glitch'), drive: document.getElementById('drive'),
                engine: document.getElementById('engineType'), engineLbl: document.getElementById('engineLabel'),
                tone: document.getElementById('tone'), rev: document.getElementById('reverbMix'),
                dMix: document.getElementById('delayMix'), db: document.getElementById('hud-db'),
                lufs: document.getElementById('hud-lufs'), canvas: document.getElementById('star-canvas'),
                ufo: document.getElementById('ufo'),
                drivePct: document.getElementById('drivePct'), tonePct: document.getElementById('tonePct'),
                reverbMixPct: document.getElementById('reverbMixPct'), delayMixPct: document.getElementById('delayMixPct'),
                compLow: document.getElementById('compLow'), compMid: document.getElementById('compMid'),
                compHigh: document.getElementById('compHigh'),
                robotFreq: document.getElementById('robotFreq'), robotMix: document.getElementById('robotMix'),
                robotPct: document.getElementById('robotPct')
            };

            let audio, source, dNode, masterGain, shaper, filter, airFilt, reverb, revG, duck, dL, dR, fbL, fbR, pL, pR, dMixG, anal, det, buffer, playing = false;
            let compLowG, compMidG, compHighG, robotOsc, robotGain, robotDry, robotWet;
            let starV = 0.25, targetV = 0.25, ufoAngle = 0;
            const ctx2d = dom.canvas.getContext('2d');
            let stars = [];

            function initStars() { 
                dom.canvas.width = window.innerWidth; dom.canvas.height = window.innerHeight; stars = []; 
                for(let i=0; i<1000; i++) {
                    let angle = Math.random() * Math.PI * 2;
                    let radius = Math.random() * dom.canvas.width;
                    let spiral = angle * 2.5;
                    stars.push({
                        x: Math.cos(angle + spiral) * radius + dom.canvas.width/2,
                        y: Math.sin(angle + spiral) * radius + dom.canvas.height/2,
                        z: Math.random() * dom.canvas.width,
                        size: Math.random() * 2,
                        color: Math.random() > 0.8 ? '#a2d2ff' : (Math.random() > 0.9 ? '#efbbff' : '#fff')
                    });
                }
            }
            
            let galaxyRot = 0;
            function animate() { 
                starV += (targetV - starV) * 0.05; targetV *= 0.98; if(targetV < 0.25) targetV = 0.25;
                const cX = dom.canvas.width / 2;
                const cY = dom.canvas.height / 2;
                galaxyRot += starV * 0.0015;
                ctx2d.fillStyle = "#000"; ctx2d.fillRect(0,0,dom.canvas.width,dom.canvas.height); 
                const grad = ctx2d.createRadialGradient(cX, cY, 0, cX, cY, dom.canvas.width/1.5);
                grad.addColorStop(0, 'rgba(30, 58, 138, 0.15)');
                grad.addColorStop(0.4, 'rgba(88, 28, 135, 0.08)');
                grad.addColorStop(1, 'rgba(0,0,0,0)');
                ctx2d.fillStyle = grad;
                ctx2d.fillRect(0,0,dom.canvas.width,dom.canvas.height);
                ctx2d.save();
                ctx2d.translate(cX, cY);
                ctx2d.rotate(galaxyRot);
                ctx2d.translate(-cX, -cY);
                stars.forEach(s => { 
                    s.z -= starV; if(s.z<=0) s.z=dom.canvas.width; 
                    let k=128/s.z, px=(s.x-cX)*k+cX, py=(s.y-cY)*k+cY; 
                    if(px>=0 && px<=dom.canvas.width && py>=0 && py<=dom.canvas.height) {
                        ctx2d.fillStyle = s.color; ctx2d.globalAlpha = (1 - s.z/dom.canvas.width);
                        ctx2d.fillRect(px,py,s.size*k*0.3,s.size*k*0.3); 
                    }
                });
                ctx2d.restore();
                ctx2d.globalAlpha = 1;
                ufoAngle += 0.006;
                const ux = cX + Math.cos(ufoAngle) * (cX * 0.75) - 30;
                const uy = cY + Math.sin(ufoAngle * 2.2) * (cY * 0.55);
                dom.ufo.style.transform = `translate(${ux}px, ${uy}px)`;
                requestAnimationFrame(animate); 
            }
            initStars(); animate();
            window.addEventListener('resize', initStars);

            async function startEngine() {
                if(audio) return;
                try {
                    audio = new (window.AudioContext || window.webkitAudioContext)();
                    dNode = audio.createGain(); 
                    shp = audio.createWaveShaper(); shp.oversample='4x';
                    filter = audio.createBiquadFilter(); 
                    airFilt = audio.createBiquadFilter(); airFilt.type = 'highshelf'; airFilt.frequency.value = 14000;
                    
                    robotOsc = audio.createOscillator(); robotOsc.type = 'sine';
                    robotGain = audio.createGain(); robotGain.gain.value = 0; 
                    robotDry = audio.createGain(); 
                    robotWet = audio.createGain(); 
                    robotOsc.connect(robotGain.gain); robotOsc.start();

                    dL = audio.createDelay(1); dR = audio.createDelay(1); fbL = audio.createGain(); fbR = audio.createGain();
                    pL = audio.createStereoPanner(); pR = audio.createStereoPanner(); dMixG = audio.createGain();
                    reverb = audio.createConvolver();
                    const len=audio.sampleRate*2.0, ir=audio.createBuffer(2,len,audio.sampleRate);
                    for(let c=0;c<2;c++){ let d=ir.getChannelData(c); for(let i=0;i<len;i++) d[i]=(Math.random()*2-1)*Math.pow(1-i/len,5); }
                    reverb.buffer=ir; revG = audio.createGain(); duck = audio.createGain(); 
                    
                    const createSplit = (type, freq) => {
                        const f1 = audio.createBiquadFilter(); f1.type = type; f1.frequency.value = freq; f1.Q.value = 0.707;
                        const f2 = audio.createBiquadFilter(); f2.type = type; f2.frequency.value = freq; f2.Q.value = 0.707;
                        f1.connect(f2); return { in: f1, out: f2 };
                    };
                    const lp = createSplit('lowpass', 280);
                    const hp = createSplit('highpass', 4200);
                    const mp_l = createSplit('highpass', 280);
                    const mp_h = createSplit('lowpass', 4200);
                    const compLo = audio.createDynamicsCompressor(); compLo.threshold.value = -28;
                    const compMi = audio.createDynamicsCompressor(); compMi.threshold.value = -24;
                    const compHi = audio.createDynamicsCompressor(); compHi.threshold.value = -30;
                    compLowG = audio.createGain(); compMidG = audio.createGain(); compHighG = audio.createGain();
                    compLowG.gain.value = 0; compMidG.gain.value = 0; compHighG.gain.value = 0;
                    masterGain = audio.createGain(); masterGain.gain.setValueAtTime(0, audio.currentTime); 
                    anal = audio.createAnalyser(); det = audio.createAnalyser(); det.fftSize=256;
                    
                    dNode.connect(shp); shp.connect(filter); filter.connect(airFilt);
                    airFilt.connect(robotDry); robotDry.connect(masterGain);
                    airFilt.connect(robotGain); robotGain.connect(robotWet); robotWet.connect(masterGain);
                    airFilt.connect(lp.in); lp.out.connect(compLo); compLo.connect(compLowG);
                    airFilt.connect(mp_l.in); mp_l.out.connect(mp_h.in); mp_h.out.connect(compMi); compMi.connect(compMidG);
                    airFilt.connect(hp.in); hp.out.connect(compHi); compHi.connect(compHighG);
                    compLowG.connect(masterGain); compMidG.connect(masterGain); compHighG.connect(masterGain);
                    airFilt.connect(dL); airFilt.connect(dR); dL.connect(fbL); fbL.connect(dL); dR.connect(fbR); fbR.connect(dR);
                    dL.connect(pL); pL.connect(dMixG); dR.connect(pR); pR.connect(dMixG); dMixG.connect(masterGain);
                    airFilt.connect(reverb); reverb.connect(revG); revG.connect(duck); duck.connect(masterGain);
                    masterGain.connect(anal); anal.connect(audio.destination);
                    setMode('wide'); updateParams();
                } catch (e) { dom.status.innerText = "LINK_ERR"; }
            }

            function setMode(m) {
                targetV += 3.5;
                document.querySelectorAll('.m-btn').forEach(b => b.classList.toggle('active', b.dataset.mode === m));
                if(!audio) return;
                let t = audio.currentTime;
                if(m==='wide'){ dL.delayTime.setTargetAtTime(0.4,t,0.1); dR.delayTime.setTargetAtTime(0.6,t,0.1); fbL.gain.setTargetAtTime(0.4,t,0.1); fbR.gain.setTargetAtTime(0.4,t,0.1); }
                if(m==='pingpong'){ dL.delayTime.setTargetAtTime(0.375,t,0.1); dR.delayTime.setTargetAtTime(0.75,t,0.1); fbL.gain.setTargetAtTime(0.5,t,0.1); fbR.gain.setTargetAtTime(0.5,t,0.1); }
                if(m==='slap'){ dL.delayTime.setTargetAtTime(0.08,t,0.1); dR.delayTime.setTargetAtTime(0.09,t,0.1); fbL.gain.setTargetAtTime(0,t,0.1); fbR.gain.setTargetAtTime(0,t,0.1); }
            }

            dom.file.addEventListener('change', async (ev) => {
                const f = ev.target.files[0]; if(!f) return;
                dom.status.innerText = "DECODING..."; 
                dom.label.innerText = f.name.length > 28 ? f.name.substring(0, 25) + "..." : f.name;
                try {
                    await startEngine(); 
                    const ab = await f.arrayBuffer();
                    audio.decodeAudioData(ab, data => {
                        buffer = data; dom.ctrls.style.opacity = "1"; dom.ctrls.style.pointerEvents = "all"; 
                        dom.status.innerText = "TRANSFORM_READY";
                        const vC=document.getElementById('viz'), vX=vC.getContext('2d');
                        vC.width = vC.offsetWidth; vC.height = vC.offsetHeight;
                        function renderHUD(){
                            requestAnimationFrame(renderHUD);
                            if(playing && det){ 
                                let d_u8=new Uint8Array(det.frequencyBinCount); det.getByteTimeDomainData(d_u8); 
                                let p=0, rms=0; for(let i=0; i<d_u8.length; i++) { let v=(d_u8[i]-128)/128; p=Math.max(p,Math.abs(v)); rms += v*v; } 
                                rms = Math.sqrt(rms / d_u8.length);
                                if (p > 0.04) duck.gain.setTargetAtTime(Math.max(0,1-(p*7)),audio.currentTime,0.02); 
                                else duck.gain.setTargetAtTime(1.0,audio.currentTime,0.2);
                                let dbV = 20*Math.log10(p+0.0001);
                                dom.db.innerText = `dB: ${dbV < -60 ? '-Inf' : dbV.toFixed(1)}`;
                                dom.lufs.innerText = `RMS: ${(rms*100).toFixed(1)}%`;
                            }
                            let da=new Uint8Array(128); if(anal) {
                                anal.getByteFrequencyData(da); vX.clearRect(0,0,vC.width,vC.height); 
                                let barW = (vC.width / 128);
                                for(let i=0;i<128;i++) { 
                                    if (i < 20) vX.fillStyle = "#5e00ff";
                                    else if (i < 60) vX.fillStyle = "#0077ff";
                                    else if (i < 100) vX.fillStyle = "#00f2ff";
                                    else vX.fillStyle = "#ffffff";
                                    vX.fillRect(i * barW, vC.height - (da[i]/255)*vC.height, barW - 1, (da[i]/255)*vC.height); 
                                }
                            }
                        } renderHUD();
                    }, (err) => { dom.status.innerText = "DECODE_ERR"; });
                } catch (err) { dom.status.innerText = "LINK_LOST"; }
            });

            dom.play.onclick = async () => {
                await startEngine(); if(audio.state==='suspended') await audio.resume();
                if(playing){ 
                    masterGain.gain.linearRampToValueAtTime(0, audio.currentTime + 0.15); 
                    setTimeout(() => { if(source) source.stop(); playing=false; dom.play.innerText="Play"; dom.play.style.background="#fff"; }, 160);
                    targetV = 0.25;
                } else if(buffer) { 
                    source=audio.createBufferSource(); source.buffer=buffer; source.connect(dNode); source.loop=true; 
                    masterGain.gain.setValueAtTime(0, audio.currentTime);
                    source.start(audio.currentTime + 0.05); 
                    playing=true;
                    masterGain.gain.linearRampToValueAtTime(0.85, audio.currentTime + 0.25); 
                    dom.play.innerText="Stop"; dom.play.style.background="var(--blue)"; 
                    targetV = 6.0;
                }
            };

            function updateParams() { 
                targetV += 0.8;
                const type = parseInt(dom.engine.value); dom.engineLbl.innerText = ["Bass", "Lead", "Pluck", "Pad", "Vocal"][type];
                if(!audio) return;
                const dv = parseFloat(dom.drive.value), tv = parseFloat(dom.tone.value);
                const rm = parseFloat(dom.robotMix.value);
                dom.drivePct.innerText = Math.round(((dv - 1) / 49) * 100) + "%";
                dom.tonePct.innerText = Math.round(((tv + 12) / 24) * 100) + "%";
                dom.reverbMixPct.innerText = Math.round(parseFloat(dom.rev.value) * 100) + "%";
                dom.delayMixPct.innerText = Math.round((parseFloat(dom.dMix.value) / 0.8) * 100) + "%";
                dom.robotPct.innerText = Math.round(rm * 100) + "%";
                
                robotOsc.frequency.setTargetAtTime(dom.robotFreq.value, audio.currentTime, 0.1);
                robotWet.gain.setTargetAtTime(rm, audio.currentTime, 0.05);
                robotDry.gain.setTargetAtTime(1 - rm, audio.currentTime, 0.05);

                compLowG.gain.setTargetAtTime(dom.compLow.value * 2.0, audio.currentTime, 0.05);
                compMidG.gain.setTargetAtTime(dom.compMid.value * 1.8, audio.currentTime, 0.05);
                compHighG.gain.setTargetAtTime(dom.compHigh.value * 2.2, audio.currentTime, 0.05);

                const curve = new Float32Array(44100);
                if(type === 4) { 
                    for(let i=0;i<44100;i++){ let x=(i*2)/44100-1; curve[i] = Math.tanh(x * (1.02 + dv*0.012)); }
                    airFilt.gain.setTargetAtTime(5.0 + (dv * 0.15), audio.currentTime, 0.05);
                    filter.type = 'peaking'; filter.frequency.setTargetAtTime(1400, audio.currentTime, 0.05); filter.gain.setTargetAtTime(tv, audio.currentTime, 0.05);
                } else {
                    for(let i=0;i<44100;i++){ let x=(i*2)/44100-1; curve[i]=((3 + dv)*x*22*(Math.PI/180))/(Math.PI + dv*Math.abs(x)); }
                    airFilt.gain.setTargetAtTime(0, audio.currentTime, 0.05);
                    filter.type = (type === 0) ? 'lowpass' : (type === 2) ? 'highpass' : 'lowshelf';
                    filter.frequency.setTargetAtTime(type === 0 ? 350 : 800, audio.currentTime, 0.05); filter.gain.setTargetAtTime(tv, audio.currentTime, 0.05);
                }
                shp.curve = curve;
                dNode.gain.setTargetAtTime(1+(dv/30),audio.currentTime,0.05); dMixG.gain.setTargetAtTime(dom.dMix.value,audio.currentTime,0.05); revG.gain.setTargetAtTime(dom.rev.value,audio.currentTime,0.05);
            }

            [dom.drive, dom.engine, dom.tone, dom.rev, dom.dMix, dom.compLow, dom.compMid, dom.compHigh, dom.robotFreq, dom.robotMix].forEach(m => m.oninput = updateParams);
            document.querySelectorAll('.m-btn').forEach(b => b.onclick = () => setMode(b.dataset.mode));
            
            dom.glitch.onclick = () => { 
                targetV = 15.0; dom.drive.value=Math.random()*40; dom.engine.value=Math.floor(Math.random()*5); dom.tone.value=Math.random()*24-12; dom.dMix.value=Math.random()*0.5; dom.rev.value=Math.random()*0.6; 
                dom.robotMix.value=0; updateParams(); let btns = document.querySelectorAll('.m-btn'); setMode(btns[Math.floor(Math.random()*btns.length)].dataset.mode);
            };

            dom.reset.onclick = () => {
                targetV = 2.0;
                dom.drive.value = 1;
                dom.engine.value = 4;
                dom.robotMix.value = 0;
                dom.compLow.value = 0;
                dom.compMid.value = 0;
                dom.compHigh.value = 0;
                dom.tone.value = 0; // 50% analog tone
                dom.rev.value = 0;
                dom.dMix.value = 0;
                updateParams();
            };

            dom.export.onclick = async () => {
                if(!buffer) return;
                const off = new OfflineAudioContext(buffer.numberOfChannels, buffer.length+(audio.sampleRate*2), audio.sampleRate);
                const s=off.createBufferSource(); s.buffer=buffer; s.connect(off.destination); s.start();
                const res = await off.startRendering();
                const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([toWav(res)], {type:'audio/wav'})); a.download = 'volt_transformer_pro.wav'; a.click();
            };

            function toWav(buf) {
                let n=buf.numberOfChannels, len=buf.length*n*2+44, a=new ArrayBuffer(len), v=new DataView(a), p=0;
                const s16=d=>{v.setInt16(p,d,true); p+=2;}, s32=d=>{v.setUint32(p,d,true); p+=4;};
                s32(0x46464952); s32(len-8); s32(0x45564157); s32(0x20746d66); s32(16); s16(1); s16(n); s32(buf.sampleRate); s32(buf.sampleRate*2*n); s16(n*2); s16(16); s32(0x61746164); s32(len-p-4);
                for(let i=0; i<buf.length; i++) for(let c=0; c<n; c++) s16(Math.max(-1,Math.min(1,buf.getChannelData(c)[i]))*32767);
                return a;
            }
        })();
    </script>
</body>
</html>
